name: Extract boot.7z and Commit to Root

on:
  push:
    paths:
      - 'boot.7z' # 当 boot.7z 文件被推送到仓库时触发此工作流
  workflow_dispatch:
    # 允许你手动从 GitHub Actions 页面运行此工作流，方便测试

jobs:
  extract_and_commit:
    runs-on: ubuntu-latest # 或者 'windows-latest' 如果你需要特定的 Windows 环境

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # 这很重要，因为它确保了 Git Action 有权限推送更改
          # 否则，它可能无法提交和推送解压后的文件。
          # 'token: ${{ secrets.GITHUB_TOKEN }}' 是 actions/checkout@v4 的默认值，
          # 但明确写出来能让你更清楚地理解其作用。
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install 7-Zip
        run: |
          sudo apt-get update
          sudo apt-get install p7zip-full -y

      - name: Delete original boot.7z file # 新增步骤：删除原文件
        run: rm boot.7z

      - name: Extract boot.7z to root directory # 修改步骤：解压到根目录
        run: |
          # 7z x boot.7z -o./ 表示解压到当前目录 (即仓库根目录)
          7z x boot.7z -o./
          # 如果 boot.7z 有密码，可以使用 -p 选项：
          # 7z x boot.7z -o./ -pYOUR_PASSWORD_HERE

      - name: Configure Git for Commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add and Commit extracted files and deletion
        run: |
          git add . # 添加所有更改，包括解压后的文件和 boot.7z 的删除
          git diff-index --quiet HEAD || git commit -m "Automated: Extract boot.7z to root and remove original"

      - name: Push changes
        run: git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # 再次确认使用 GITHUB_TOKEN 进行认证
